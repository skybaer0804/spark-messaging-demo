# v2.2.0 프로젝트 대대적 개선 계획 - 최종 요약

**작성일**: 2026-01-09
**상태**: 진행 준비 중
**목표**: Spark SDK 안정성 강화 + 전체 아키텍처 고도화

---

## 📌 핵심 메시지

> **v2.1.0까지 구현한 기능들을 안정화하고, 개발 가이드라인과 아키텍처를 대대적으로 정비하여 "카카오톡 수준의 신뢰할 수 있는 메시징 앱"으로 발전시키는 버전**

### 현황
- ✅ 기본 채팅, 푸시 알림, 화상회의 기능 구현 완료
- ❌ **Spark SDK 안정성 문제**: 메시지 손실, 타이밍 이슈
- ❌ **개발 표준 부재**: 각자 다른 방식의 구현
- ❌ **아키텍처 복잡도**: 흩어진 로직, 불명확한 데이터 흐름

---

## 🎯 5가지 개선 축

### 1️⃣ 가이드라인 고도화 (RULES.md)
**기간**: 3-4일 | **우선순위**: 🔴 High

#### 주요 성과
- ✅ 디자인 토큰 3단계 계층 구조 명문화
- ✅ SCSS + BEM 네이밍 규칙 강화 (중첩 최대 3단계)
- ✅ 컴포넌트 모듈화 원칙 확립
- ✅ TypeScript 타입 안정성 가이드

#### 기대 효과
- 새 팀원 온보딩 시간 **50% 단축**
- 스타일 유지보수 **중앙화**
- 코드 리뷰 기준 **명확화**

---

### 2️⃣ 디렉토리 구조 재편 (Generic & Slim)
**기간**: 5-6일 | **우선순위**: 🔴 High

#### 3가지 주요 작업

**A. 불필요 도메인 제거**
```
삭제: ReverseAuction 관련 모든 파일/폴더
- src/domains/ReverseAuction/
- server/controllers/reverseAuctionController.js
- 라우터, 메뉴, 타입 정의 등
```

**B. 제네릭 컴포넌트 통합**
```
ui-components/
├── Button/       (TypeScript, Props 최소화, 완전히 제어됨)
├── Input/
├── Card/
├── Dialog/
└── Avatar/
```

**C. 도메인 중심 아키텍처 (핵심 3개)**
```
domains/
├── Chat/
│   ├── components/    (ChatList, ChatWindow, ChatMessage)
│   ├── hooks/         (useChatRoom, useMessageSync, useOptimisticUpdate)
│   ├── types/
│   ├── utils/
│   └── __tests__/
├── Notification/
└── VideoMeeting/

core/
├── api/              (모든 API 통합)
├── socket/           (소켓 이벤트 관리)
├── context/          (전역 상태)
└── utils/            (공통 유틸)
```

#### 기대 효과
- **50%의 코드 정리** (불필요한 코드 삭제)
- 도메인별 로직 **명확한 분리**
- 서비스 간 **중복 제거**

---

### 3️⃣ 레이아웃 대전환 (Mobile-First & Slim LNB)
**기간**: 5-7일 | **우선순위**: 🟠 Medium

#### 카톡 스타일의 UI 구조

**Desktop 레이아웃**:
```
┌──────────┬───────────────┬──────────────┐
│  LNB     │  Chat Window  │  Side Panel  │
│ (80px)   │    (1fr)      │   (300px)    │
└──────────┴───────────────┴──────────────┘
```

**Mobile 레이아웃**:
```
┌─────────────────────┐
│  Chat Window        │
│                     │
├─────────────────────┤
│  LNB (하단 탭바)    │
│  💬 🔔 📹 ⚙️ 👤   │
└─────────────────────┘
```

**LNB 아이콘 (5개)**
- 💬 Chat (채팅방 목록)
- 🔔 Notification (알림)
- 📹 VideoMeeting (화상회의)
- ⚙️ Settings (설정)
- 👤 Profile (프로필)

#### 각 탭의 핵심 기능

| 탭 | 주요 UI | 필터링 |
|----|---------|-------|
| **Chat** | 방 목록 | [전체] [안읽음] |
| **Notification** | 알림 리스트 | [전체] [안읽음] |
| **VideoMeeting** | 회의 목록 | [진행중] [예약됨] |
| **Settings** | 프로필, 알림 설정, 테마 | - |

#### 기대 효과
- **UX 복잡도 50% 감소**
- 모바일/데스크톱 **일관된 경험**
- 직관적인 네비게이션

---

### 4️⃣ 데이터 아키텍처 개선 (Schema Upgrade)
**기간**: 4-5일 | **우선순위**: 🔴 High

#### 신규 모델: UserChatRoom (Junction Table)

**목적**: 유저별 채팅방 상태 관리 최적화

```javascript
{
  userId: ObjectId (ref: User),
  roomId: ObjectId (ref: ChatRoom),
  unreadCount: Number,        // 안읽음 카운트
  lastReadMessageId: ObjectId, // 스크롤 복구
  isPinned: Boolean,           // 상단 고정
  notificationEnabled: Boolean, // 방별 알림 ON/OFF
  createdAt: Date
}
```

#### Message 모델 보강

```javascript
{
  // 기존 필드
  roomId, senderId, content, type, readBy, timestamp,
  
  // [NEW] 시퀀스 번호 - 타임스탐프 역전 방지
  sequenceNumber: Number (증가 순서),
  
  // [NEW] 삭제 추적
  isDeleted: Boolean,
  deletedBy: 'sender' | 'all',
  
  // [NEW] 낙관적 업데이트
  tempId: String
}
```

#### VideoMeeting 모델 고도화

```javascript
{
  roomId, organizerId, title, status,
  
  // [NEW] 용량 제한
  maxParticipants: Number,
  
  // [NEW] 녹화 기능
  recordingUrl: String,
  isRecording: Boolean,
  
  // [NEW] 실시간 참여자 추적
  activeParticipants: [{ userId, joinedAt, leftAt }]
}
```

#### 기대 효과
- **시퀀스 기반 정렬** → 메시지 손실 방지
- **안읽음 추적** → 정확한 알림 카운트
- **낙관적 업데이트** → 빠른 사용자 경험

---

### 5️⃣ 도메인별 유스케이스 안정화 (실시간 로직)
**기간**: 7-10일 | **우선순위**: 🔴 High

#### UC-C1: 채팅방 목록 실시간 동기화

**Flow**:
```
1. 사용자가 메시지 전송
2. [서버] DB에 저장 + 시퀀싱
3. [서버] 모든 수신자의 unreadCount 증가
4. [서버] 소켓으로 ROOM_LIST_UPDATED 브로드캐스트
5. [클라이언트] 자동으로 방 목록 최상단으로 이동, 카운트 갱신
```

#### UC-C2: 낙관적 업데이트

**Flow**:
```
1. [클라이언트] tempId 생성 후 즉시 UI에 렌더링 (status: 'sending')
2. [서버] 메시지 저장 후 _id + sequenceNumber 응답
3. [클라이언트] tempId → 실제 _id 매핑, status → 'sent'
```

#### UC-C3: Reconnection Sync

**Flow**:
```
1. 네트워크 단절 감지
2. 재연결 시, 마지막 시퀀스 번호를 서버에 전송
3. [서버] 그 이후의 메시지들만 응답
4. [클라이언트] 자동으로 병합 (중복 제거)
```

#### UC-N1: 컨텍스트 기반 푸시

**Flow**:
```
1. [서버] 사용자가 현재 보는 방 확인 (Redis)
2. 메시지 방 == 현재 방? → 푸시 생략 (소켓으로만 전송)
3. 메시지 방 != 현재 방? → Web-Push 발송
```

#### UC-V1: 채팅방 연동 회의 생성

**Flow**:
```
1. 채팅방에서 "화상회의" 아이콘 클릭
2. VideoMeeting 레코드 생성 (status: 'ongoing')
3. 해당 방에 시스템 메시지 자동 발송
4. 푸시 알림으로 참여자 통보
```

#### 기대 효과
- **메시지 손실 0** (시퀀싱)
- **네트워크 안정성** (자동 동기화)
- **즉각적인 UX** (낙관적 업데이트)

---

## 📊 .cursorrules 수정 제안 (8개 섹션)

### 추가될 섹션

1. **Socket & Real-time 개발 규칙**
   - 이벤트 네이밍 컨벤션 (`REQUEST_*`, `*_UPDATED`)
   - 메시지 시퀀싱 규칙 (필수 필드)

2. **낙관적 업데이트 & Reconnection Sync**
   - Step-by-step 구현 가이드
   - 코드 템플릿

3. **에러 처리 & 로깅**
   - 에러 분류 (NetworkError, ValidationError, ServerError)
   - 로깅 레벨 및 규칙
   - 재시도 로직

4. **테스트 작성 규칙**
   - 파일 위치 구조
   - 타이틀 컨벤션 ("should ... when ...")
   - 단위/통합/E2E 템플릿
   - Mock 작성 패턴

5. **성능 최적화**
   - 메시지 리스트 가상화 (1000+ 메시지)
   - 메모리 누수 방지 (cleanup 함수)
   - 번들 최적화

6. **도메인별 구조 명시**
   - 디렉토리 레이아웃
   - Barrel Export 패턴

7. **타입 안정성**
   - 도메인별 타입 정의
   - API 응답 타입
   - 훅 반환 타입

8. **Output Language: Korean** (유지)

---

## 🧪 종합 테스트 전략

### Phase별 테스트

| Phase | 범위 | 도구 | 소요시간 |
|-------|------|------|--------|
| **Unit Test** | 훅, 유틸, API | Jest + RTL | 2-3일 |
| **Integration Test** | 프론트 + 백엔드 API | Supertest | 2-3일 |
| **E2E Test** | 전체 사용자 흐름 | Playwright | 2-3일 |
| **Performance Test** | 대량 메시지, 동시 사용자 | lighthouse | 1-2일 |

### 점검 체크리스트

✅ **Core Functionality**
- [ ] 채팅방 목록 실시간 업데이트
- [ ] 메시지 발송 → DB → 소켓 → 수신 (전 과정 로깅)
- [ ] 낙관적 업데이트 (느린 네트워크 테스트)
- [ ] Reconnection Sync (자동 누락 메시지 로드)
- [ ] 안읽음 카운트 정확성
- [ ] 방별 알림 설정

✅ **Real-time & Socket**
- [ ] 소켓 이벤트 로그 (Chrome DevTools WS)
- [ ] 중복 메시지 수신 없음
- [ ] 메시지 순서 보장 (sequenceNumber)
- [ ] 푸시: 오프라인 사용자에게만 전송

✅ **Database**
- [ ] UserChatRoom 테이블 정상
- [ ] Message.sequenceNumber 인덱스
- [ ] Migration 스크립트 실행 (기존 데이터 이전)

✅ **UI/UX**
- [ ] LNB 반응형 (모바일/데스크톱)
- [ ] Chat Tab 필터링 (전체/안읽음)
- [ ] Notification/VideoMeeting 탭 작동
- [ ] Settings 기본 설정

✅ **Cross-browser & Device**
- [ ] Chrome, Safari, Firefox
- [ ] 모바일 (iPhone, Android)
- [ ] PWA 설치 후 오프라인 모드

---

## 📈 개발 타임라인

```
[Week 1-2] Phase 1-2: 가이드라인 + 구조 재편
  ├─ Day 1-3: RULES.md 작성
  ├─ Day 4-5: ReverseAuction 삭제
  └─ Day 6-7: ui-component 재설계

[Week 2-3] Phase 3: 레이아웃 대전환
  ├─ Day 8: LNB 컴포넌트 설계
  ├─ Day 9-10: 각 탭 메인 컴포넌트
  └─ Day 11-12: 반응형 테스트

[Week 3-4] Phase 4-5: 데이터 + 안정화
  ├─ Day 13-15: Schema 마이그레이션
  ├─ Day 16-20: 유스케이스 구현
  └─ Day 21-25: 테스트 (단위/통합/E2E)

총 예상: 26-37일 (약 4-5주)
```

---

## 💡 v2.2.0의 핵심 가치

### Before (v2.1.0)
```
❌ "부분적이고 불안정한 기능"
  - 메시지 손실 가능성
  - 개발자마다 다른 구현 방식
  - 복잡한 아키텍처
  - 테스트 부족
```

### After (v2.2.0)
```
✅ "카톡 수준의 신뢰할 수 있는 앱"
  - 메시지 손실 0 (시퀀싱)
  - 명확한 개발 가이드 (RULES.md)
  - 깔끔한 아키텍처 (3개 도메인)
  - 종합 테스트 전략
  - 빠른 사용자 경험 (낙관적 업데이트)
  - 자동 복구 (Reconnection Sync)
```

---

## 📚 3가지 생성 문서

### 1. v2.2.0_DETAILED_PLAN.md (약 1600줄)
**가장 상세한 구현 계획서**
- 5가지 Phase별 구체적 작업
- MongoDB 스키마 업데이트 (상세 코드)
- 5가지 유스케이스 구현 (코드 포함)
- 7가지 테스트 전략

### 2. .cursorrules_v2.2.0_PROPOSAL.md (약 1200줄)
**.cursorrules 상세 수정안**
- 8개 새 섹션의 구체적 내용
- 코드 템플릿 및 패턴
- 타이틀 컨벤션, Mock 패턴

### 3. v2.2.0_SUMMARY.md (이 문서)
**전체 계획의 최종 요약**
- 우선순위 및 타임라인
- 핵심 가치 정리
- 다음 스텝 안내

---

## 📥 다운로드 방법

**3개 문서 모두 아래에서 다운로드 가능합니다:**

1. **v2.2.0_DETAILED_PLAN.md** ← 다운로드
2. **.cursorrules_v2.2.0_PROPOSAL.md** ← 다운로드
3. **v2.2.0_SUMMARY.md** ← 다운로드

각 문서는 Markdown 형식(.md)이므로 텍스트 에디터 또는 GitHub에서 바로 열 수 있습니다.

---

## ✨ 최종 메시지

> v2.2.0은 **"혼란에서 질서로"** 가는 전환점입니다.
>
> - **개발 가이드라인** (RULES.md) → 누구나 같은 기준으로 작성
> - **깔끔한 아키텍처** (3개 도메인) → 관심사 분리
> - **견고한 데이터 흐름** (시퀀싱 + 낙관적 업데이트) → 메시지 손실 0
> - **종합 테스트** (단위/통합/E2E) → 신뢰할 수 있는 품질
>
> 이 4가지가 완성되면, **"Spark Messaging Demo"는 더 이상 데모가 아닌 프로덕션급 서비스**가 됩니다.

---

**준비가 되면, v2.2.0 개발을 시작하세요! 🚀**

---

**작성**: 2026-01-09 (금요일 10:33 AM)
**대상**: Spark Messaging Demo v2.2.0 개발팀
