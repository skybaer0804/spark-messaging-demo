# Spark Messaging Demo v2.0.0 설계 문서

이 문서는 프로젝트의 백엔드 통합, 보안 강화, 그리고 실시간 성능 최적화를 위한 v2.0.0 업데이트 계획을 담고 있습니다.

---

## 1. Q&A: 아키텍처 핵심 결정 사항

**Q1: 하나의 Git 저장소에 백엔드/프론트를 나눠도 될까요? PWA/TWA에 영향은 없나요?**
- **A**: 전혀 문제 없습니다. 오히려 관리가 용이합니다. PWA/TWA는 빌드된 정적 자산의 서빙 방식이 중요할 뿐, 소스 코드의 위치는 영향을 주지 않습니다.

**Q2: Socket SDK는 프론트와 백엔드 중 어디에 있어야 하나요? 데이터 유실 방지는 어떻게 하죠?**
- **A**: **수신은 프론트, 전송은 백엔드**를 거칩니다. "DB 선저장 후 소켓 전송" 전략을 위해 프론트가 직접 소켓을 쏘는 대신 백엔드 API를 호출합니다. 이를 통해 DB 기록과 실시간 전송의 무결성을 보장합니다.

**Q3: Redis 도입 시 추천하는 흐름은 무엇인가요?**
- **A**: Redis는 **유저 접속 상태 관리, API 속도 제한(Rate Limit), 최신 메시지 캐싱**에 사용합니다. 영구 저장은 MongoDB, 고속 조회는 Redis가 담당하는 Layered Architecture를 권장합니다.

---

## 2. 시스템 아키텍처 흐름 (Message Flow)

1.  **메시지 발송**: Client (PWA) -> `POST /api/chat/message` (JWT 포함)
2.  **인증/검증**: Express 서버가 JWT 확인 및 해당 방에 대한 권한 검증
3.  **영구 저장**: Express 서버가 MongoDB에 메시지 데이터 저장
4.  **캐싱**: Redis에 최신 메시지 업데이트 및 방의 'Last Message' 정보 갱신
5.  **실시간 전송**: Express 서버가 Socket SDK를 통해 수신자들에게 메시지 브로드캐스트
6.  **푸시 알림**: Redis 상에서 수신자가 오프라인인 경우, Web-Push(VAPID) 발송

---

## 3. MongoDB 데이터 스키마 (Mongoose)

### User Model
```javascript
{
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true }, // hashed
  username: { type: String, required: true },
  avatar: String,
  pushSubscription: {
    endpoint: String,
    keys: {
      p256dh: String,
      auth: String
    }
  },
  status: { type: String, enum: ['online', 'offline'], default: 'offline' },
  createdAt: { type: Date, default: Date.now }
}
```

### ChatRoom Model
```javascript
{
  name: { type: String, default: 'Group Chat' },
  members: [{ type: Schema.Types.ObjectId, ref: 'User' }],
  isGroup: { type: Boolean, default: false },
  lastMessage: { type: Schema.Types.ObjectId, ref: 'Message' },
  createdAt: { type: Date, default: Date.now }
}
```

### Message Model
```javascript
{
  roomId: { type: Schema.Types.ObjectId, ref: 'ChatRoom', index: true },
  senderId: { type: Schema.Types.ObjectId, ref: 'User' },
  content: { type: String, required: true },
  type: { type: String, enum: ['text', 'file', 'image'], default: 'text' },
  readBy: [{ type: Schema.Types.ObjectId, ref: 'User' }],
  timestamp: { type: Date, default: Date.now }
}
```

---

## 4. 백엔드 (Express.js) 구조 제안

백엔드는 `server/` 디렉토리에 위치하며 다음과 같이 구성합니다.

```text
server/
├── config/
│   ├── db.js          # MongoDB Atlas 연동
│   ├── redis.js       # Redis 클라이언트 설정
│   └── passport.js    # JWT 인증 전략
├── controllers/
│   ├── authController.js    # 로그인, 회원가입
│   ├── chatController.js    # 방 생성, 메시지 전송 로직
│   └── pushController.js    # Web-Push 구독 관리
├── models/            # Mongoose 스키마
├── routes/
│   ├── auth.js
│   ├── chat.js
│   └── push.js
├── services/
│   ├── socketService.js     # Spark Messaging SDK 연동 관리
│   └── notification.js      # Web-Push 발송 로직
├── middleware/
│   ├── auth.js              # JWT 검증 미들웨어
│   └── error.js             # 공통 에러 핸들러
├── .env                     # 환경 변수 (DB_URI, JWT_SECRET, VAPID_KEYS)
└── index.js                 # 서버 진입점
```

---

## 5. 향후 작업 로드맵
1. `server/` 폴더 초기화 및 기본 패키지 설치 (`express`, `mongoose`, `redis`, `jsonwebtoken`, `web-push`)
2. MongoDB Atlas 클러스터 생성 및 연결
3. 회원가입/로그인 API 구현 및 JWT 연동
4. 채팅방 생성 및 메시지 이력 조회 API 구현
5. 프론트엔드(PWA)에서 기존 SDK 호출 로직을 백엔드 API 호출로 전환
6. Web-Push 알림 기능 통합

