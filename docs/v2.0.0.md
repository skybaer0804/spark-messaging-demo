# Spark Messaging Demo v2.0.0 ì„¤ê³„ ë¬¸ì„œ

ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì˜ ë°±ì—”ë“œ í†µí•©, ë³´ì•ˆ ê°•í™”, ê·¸ë¦¬ê³  ì‹¤ì‹œê°„ ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ v2.0.0 ì—…ë°ì´íŠ¸ ê³„íšì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

---

## 1. Q&A: ì•„í‚¤í…ì²˜ í•µì‹¬ ê²°ì • ì‚¬í•­

**Q1: í•˜ë‚˜ì˜ Git ì €ì¥ì†Œì— ë°±ì—”ë“œ/í”„ë¡ íŠ¸ë¥¼ ë‚˜ëˆ ë„ ë ê¹Œìš”? PWA/TWAì— ì˜í–¥ì€ ì—†ë‚˜ìš”?**
- **A**: ì „í˜€ ë¬¸ì œ ì—†ìŠµë‹ˆë‹¤. ì˜¤íˆë ¤ ê´€ë¦¬ê°€ ìš©ì´í•©ë‹ˆë‹¤. PWA/TWAëŠ” ë¹Œë“œëœ ì •ì  ìì‚°ì˜ ì„œë¹™ ë°©ì‹ì´ ì¤‘ìš”í•  ë¿, ì†ŒìŠ¤ ì½”ë“œì˜ ìœ„ì¹˜ëŠ” ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.

**Q2: Socket SDKëŠ” í”„ë¡ íŠ¸ì™€ ë°±ì—”ë“œ ì¤‘ ì–´ë””ì— ìˆì–´ì•¼ í•˜ë‚˜ìš”? ë°ì´í„° ìœ ì‹¤ ë°©ì§€ëŠ” ì–´ë–»ê²Œ í•˜ì£ ?**
- **A**: **ìˆ˜ì‹ ì€ í”„ë¡ íŠ¸, ì „ì†¡ì€ ë°±ì—”ë“œ**ë¥¼ ê±°ì¹©ë‹ˆë‹¤. "DB ì„ ì €ì¥ í›„ ì†Œì¼“ ì „ì†¡" ì „ëµì„ ìœ„í•´ í”„ë¡ íŠ¸ê°€ ì§ì ‘ ì†Œì¼“ì„ ì˜ëŠ” ëŒ€ì‹  ë°±ì—”ë“œ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ DB ê¸°ë¡ê³¼ ì‹¤ì‹œê°„ ì „ì†¡ì˜ ë¬´ê²°ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

**Q3: Redis ë„ì… ì‹œ ì¶”ì²œí•˜ëŠ” íë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”?**
- **A**: RedisëŠ” **ìœ ì € ì ‘ì† ìƒíƒœ ê´€ë¦¬, API ì†ë„ ì œí•œ(Rate Limit), ìµœì‹  ë©”ì‹œì§€ ìºì‹±**ì— ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜êµ¬ ì €ì¥ì€ MongoDB, ê³ ì† ì¡°íšŒëŠ” Redisê°€ ë‹´ë‹¹í•˜ëŠ” Layered Architectureë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.

---

## 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ íë¦„ (Message Flow)

1.  **ë©”ì‹œì§€ ë°œì†¡**: Client (PWA) -> `POST /api/chat/message` (JWT í¬í•¨)
2.  **ì¸ì¦/ê²€ì¦**: Express ì„œë²„ê°€ JWT í™•ì¸ ë° í•´ë‹¹ ë°©ì— ëŒ€í•œ ê¶Œí•œ ê²€ì¦
3.  **ì˜êµ¬ ì €ì¥**: Express ì„œë²„ê°€ MongoDBì— ë©”ì‹œì§€ ë°ì´í„° ì €ì¥
4.  **ìºì‹±**: Redisì— ìµœì‹  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ ë° ë°©ì˜ 'Last Message' ì •ë³´ ê°±ì‹ 
5.  **ì‹¤ì‹œê°„ ì „ì†¡**: Express ì„œë²„ê°€ Socket SDKë¥¼ í†µí•´ ìˆ˜ì‹ ìë“¤ì—ê²Œ ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸
6.  **í‘¸ì‹œ ì•Œë¦¼**: Redis ìƒì—ì„œ ìˆ˜ì‹ ìê°€ ì˜¤í”„ë¼ì¸ì¸ ê²½ìš°, Web-Push(VAPID) ë°œì†¡

---

## 3. MongoDB ë°ì´í„° ìŠ¤í‚¤ë§ˆ (Mongoose)

### User Model
```javascript
{
  email: { type: String, required: true, unique: true },
  password: { type: String, required: true }, // hashed
  username: { type: String, required: true },
  avatar: String,
  pushSubscription: {
    endpoint: String,
    keys: {
      p256dh: String,
      auth: String
    }
  },
  status: { type: String, enum: ['online', 'offline'], default: 'offline' },
  createdAt: { type: Date, default: Date.now }
}
```

### ChatRoom Model
```javascript
{
  name: { type: String, default: 'Group Chat' },
  members: [{ type: Schema.Types.ObjectId, ref: 'User' }],
  isGroup: { type: Boolean, default: false },
  lastMessage: { type: Schema.Types.ObjectId, ref: 'Message' },
  createdAt: { type: Date, default: Date.now }
}
```

### Message Model
```javascript
{
  roomId: { type: Schema.Types.ObjectId, ref: 'ChatRoom', index: true },
  senderId: { type: Schema.Types.ObjectId, ref: 'User' },
  content: { type: String, required: true },
  type: { type: String, enum: ['text', 'file', 'image'], default: 'text' },
  readBy: [{ type: Schema.Types.ObjectId, ref: 'User' }],
  timestamp: { type: Date, default: Date.now }
}
```

---

## 4. ë°±ì—”ë“œ (Express.js) êµ¬ì¡° ì œì•ˆ

ë°±ì—”ë“œëŠ” `server/` ë””ë ‰í† ë¦¬ì— ìœ„ì¹˜í•˜ë©° ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±í•©ë‹ˆë‹¤.

```text
server/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ db.js          # MongoDB Atlas ì—°ë™
â”‚   â”œâ”€â”€ redis.js       # Redis í´ë¼ì´ì–¸íŠ¸ ì„¤ì •
â”‚   â””â”€â”€ passport.js    # JWT ì¸ì¦ ì „ëµ
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ authController.js    # ë¡œê·¸ì¸, íšŒì›ê°€ì…
â”‚   â”œâ”€â”€ chatController.js    # ë°© ìƒì„±, ë©”ì‹œì§€ ì „ì†¡ ë¡œì§
â”‚   â””â”€â”€ pushController.js    # Web-Push êµ¬ë… ê´€ë¦¬
â”œâ”€â”€ models/            # Mongoose ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ chat.js
â”‚   â””â”€â”€ push.js
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ socketService.js     # Spark Messaging SDK ì—°ë™ ê´€ë¦¬
â”‚   â””â”€â”€ notification.js      # Web-Push ë°œì†¡ ë¡œì§
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.js              # JWT ê²€ì¦ ë¯¸ë“¤ì›¨ì–´
â”‚   â””â”€â”€ error.js             # ê³µí†µ ì—ëŸ¬ í•¸ë“¤ëŸ¬
â”œâ”€â”€ .env                     # í™˜ê²½ ë³€ìˆ˜ (DB_URI, JWT_SECRET, VAPID_KEYS)
â””â”€â”€ index.js                 # ì„œë²„ ì§„ì…ì 
```

---

## 5. v2.0.0 ê°œë°œ ì™„ë£Œ ì‚¬í•­ (2026-01-07)

### âœ… í”„ë¡œì íŠ¸ êµ¬ì¡° ë° ë°±ì—”ë“œ ê¸°ë°˜ êµ¬ì¶•
- `client/` ë° `server/` ë””ë ‰í† ë¦¬ ë¶„ë¦¬ë¡œ ê´€ì‹¬ì‚¬ ë¶„ë¦¬ ë° ëª¨ë“ˆí™” ì™„ì„±.
- Express.js ê¸°ë°˜ REST API ì„œë²„ êµ¬ì¶• ë° MongoDB Atlas ì—°ë™.
- Redis ì„œë²„ ì—°ë™ì„ í†µí•œ ê³ ì† ìœ ì € ìƒíƒœ(Online/Offline) ê´€ë¦¬ ë ˆì´ì–´ ì¶”ê°€.

### âœ… ë³´ì•ˆ ë° ì¸ì¦ (Authentication)
- JWT(JSON Web Token) ê¸°ë°˜ì˜ ì‚¬ìš©ì ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„.
- `bcryptjs`ë¥¼ ì‚¬ìš©í•œ ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” ì €ì¥ ë° ê²€ì¦.
- í”„ë¡ íŠ¸ì—”ë“œ `ProtectedRoute` ì ìš©ìœ¼ë¡œ ë¹„ì¸ì¦ ì‚¬ìš©ì ì ‘ê·¼ ì œí•œ.

### âœ… ì‹¤ì‹œê°„ ì±„íŒ… (Real-time Messaging)
- **DB-First ì „ëµ**: ë©”ì‹œì§€ ì „ì†¡ ì‹œ MongoDBì— ì„ ì €ì¥ í›„ ì†Œì¼“ ë¸Œë¡œë“œìºìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥.
- ì±„íŒ…ë°© ìƒì„±, ì°¸ì—¬, ëª©ë¡ ì¡°íšŒ ë° ê³¼ê±° ë©”ì‹œì§€ ì´ë ¥(History) ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„.
- `@skybaer0804/spark-messaging-client` SDKì˜ ì„œë²„ ì‚¬ì´ë“œ í†µí•©.

### âœ… ì•Œë¦¼ ì‹œìŠ¤í…œ (Notification)
- Web-Push(VAPID) í‘œì¤€ì„ í™œìš©í•œ ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼ ê¸°ëŠ¥ êµ¬í˜„.
- **í‘¸ì‹œ ìµœì í™”**: Redis ìƒíƒœê°’ì„ ì¡°íšŒí•˜ì—¬ **ì˜¤í”„ë¼ì¸ ì‚¬ìš©ìì—ê²Œë§Œ ì„ íƒì ìœ¼ë¡œ í‘¸ì‹œ ë°œì†¡** ë¡œì§ ì ìš©.
- ì„œë¹„ìŠ¤ ì›Œì»¤(Service Worker) ì—°ë™ì„ í†µí•œ ë°±ê·¸ë¼ìš´ë“œ ì•Œë¦¼ ìˆ˜ì‹  ì§€ì›.

---

## 6. v2.0.0 ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì„œë¹„ìŠ¤ ì‹¤í–‰ ì „ ì•„ë˜ í•­ëª©ë“¤ì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

### âš™ï¸ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
- [ ] `server/.env` íŒŒì¼ì— `MONGODB_URI`, `REDIS_URL`, `JWT_SECRET`ì´ ì„¤ì •ë˜ì—ˆëŠ”ê°€?
- [ ] `server/.env` ë° `client/.env`ì— ë™ì¼í•œ `VAPID_PUBLIC_KEY`ê°€ ì…ë ¥ë˜ì—ˆëŠ”ê°€?
- [ ] `SPARK_PROJECT_KEY` ë° `SPARK_SERVER_URL`ì´ ì†Œì¼“ ì„œë²„ ì„¤ì •ê³¼ ì¼ì¹˜í•˜ëŠ”ê°€?

### ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë° ì„œë¹„ìŠ¤
- [ ] MongoDB Atlas í´ëŸ¬ìŠ¤í„°ê°€ í™œì„±í™”ë˜ì–´ ìˆê³  ì ‘ì† ê°€ëŠ¥í•œê°€?
- [ ] Redis ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ë©° ì„œë²„ì—ì„œ ì—°ê²° ì„±ê³µ ë¡œê·¸ê°€ ëœ¨ëŠ”ê°€?
- [ ] ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ ìŠ¹ì¸(Grant) í•˜ì˜€ëŠ”ê°€?

### ğŸ§ª ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] íšŒì›ê°€ì… í›„ ë¡œê·¸ì¸ ì‹œ í† í°ì´ `LocalStorage`ì— ì •ìƒ ì €ì¥ë˜ëŠ”ê°€?
- [ ] ë‹¤ë¥¸ ë¸Œë¼ìš°ì €/ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œ ì„œë¡œ ì‹¤ì‹œê°„ ë©”ì‹œì§€ê°€ ì „ë‹¬ë˜ëŠ”ê°€?
- [ ] ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¸ ê³„ì •ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ ì›¹ í‘¸ì‹œ ì•Œë¦¼ì´ ì˜¤ëŠ”ê°€?
- [ ] ì±„íŒ…ë°© ì…ì¥ ì‹œ ì´ì „ ëŒ€í™” ë‚´ì—­ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ëŠ”ê°€?

