# AWS S3로 채팅 파일 저장 완벽 가이드

- **작성일**: 2026년 1월 16일
- **대상**: AWS를 처음 사용하는 개발자
- **목표**: 아카이브 ON/OFF 옵션으로 파일 유지 기간을 다르게 관리하는 채팅 서비스 구축

---

## 📑 목차

1. [아키텍처 개요](#아키텍처-개요)
2. [AWS 계정 설정](#aws-계정-설정)
3. [S3 버킷 생성](#s3-버킷-생성)
4. [IAM 사용자 생성](#iam-사용자-생성)
5. [웹서버 코드 구현](#웹서버-코드-구현)
6. [Lifecycle Rule 설정](#lifecycle-rule-설정)
7. [Object Tag 기반 관리](#object-tag-기반-관리)
8. [가격 예상](#가격-예상)
9. [트러블슈팅](#트러블슈팅)

---

## 🏗️ 아키텍처 개요

### 핵심 개념

- **아카이브 ON**: 파일을 S3에 무제한 보관 (유료)
- **아카이브 OFF**: 파일을 S3에 1일만 보관 후 자동 삭제 (저비용)
- **단일 버킷 운영**: 하나의 S3 버킷 내에서 태그(Tag)를 통해 정책 분리

### 저장 구조 (권장: 태그 기반)

```
my-chat-bucket/
├── chat/
│   └── {userId}/
│       └── {timestamp}-{filename}
│           ├── Tag: archive=true (무제한 보관)
│           └── Tag: archive=false (1일 후 삭제)
```

### 데이터 흐름

1. **클라이언트 (웹앱)**: 파일과 `archiveOption` 플래그를 서버로 전송
2. **웹서버 (Node.js/Express)**:
   - 파일 검증 (크기, 형식)
   - S3 업로드 및 해당 태그 부여
   - DB에 메타데이터 및 만료일 저장
3. **AWS S3 + Lifecycle Rule**:
   - `archive=true` → 정책 제외 (무제한 보관)
   - `archive=false` → 1일 후 자동 삭제
4. **채팅 재입장 시**: 서버가 프리사인드(Presigned) URL을 생성하여 클라이언트에 제공

---

## ⚙️ AWS 계정 설정

### 1단계: AWS 계정 생성

1. AWS 공식 사이트 방문
2. "계정 만들기" 클릭 후 이메일, 비밀번호, 계정명 입력
3. 결제 정보 등록 (무료 티어: 12개월간 월 5GB 무료 제공)

### 2단계: 리전 설정

- AWS 콘솔 우측 상단 드롭다운에서 **Asia Pacific (Seoul)** 선택
- 리전 코드: `ap-northeast-2`

---

## 📦 S3 버킷 생성

1. **콘솔 이동**: AWS 검색창에 "S3" 입력 후 이동
2. **버킷 만들기**:
   - 버킷 이름: `my-chat-bucket` (전역에서 고유해야 함)
   - 리전: `ap-northeast-2` 선택
   - ACL: 비활성화 (권장)
   - 퍼블릭 액세스 차단: 모두 체크 (보안 권장, 서버를 통해서만 접근)
3. **완료**: 하단 "버킷 만들기" 클릭

---

## 🔑 IAM 사용자 생성 (프로그래밍 방식 접근)

1. **IAM 콘솔**: "IAM" 검색 후 이동
2. **사용자 만들기**:
   - 사용자 이름: `chat-s3-user`
   - 액세스 유형: "액세스 키 - 프로그래밍 방식 액세스" 선택
   - 권한 설정: "정책 직접 연결" → `AmazonS3FullAccess` 검색 후 체크

> ⚠️ **주의**: 실제 운영 환경에서는 특정 버킷에만 접근 가능한 최소 권한 정책 사용을 권장합니다.

3. **액세스 키 저장**:
   - 중요: 이 화면에서만 Secret Access Key를 확인할 수 있습니다.
   - 반드시 `.csv` 다운로드를 클릭하여 안전한 곳에 보관하세요.

---

## 💻 웹서버 코드 구현

### 1단계: 의존성 설치

```bash
npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner express multer dotenv uuid
```

### 2단계: 환경변수 설정 (.env)

```env
# AWS 설정
AWS_REGION=ap-northeast-2
AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY=YOUR_SECRET_ACCESS_KEY
S3_BUCKET=my-chat-bucket

# 서버 설정
PORT=3000
```

### 3단계: S3 클라이언트 초기화 (s3-client.js)

```javascript
const { S3Client } = require('@aws-sdk/client-s3');

const s3Client = new S3Client({
  region: process.env.AWS_REGION,
  credentials: {
    accessKeyId: process.env.AWS_ACCESS_KEY_ID,
    secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
  },
});

module.exports = { s3Client };
```

### 4단계: 업로드 및 다운로드 API (app.js)

```javascript
const { PutObjectCommand, GetObjectCommand, PutObjectTaggingCommand } = require('@aws-sdk/client-s3');
const { getSignedUrl } = require('@aws-sdk/s3-request-presigner');
const { v4: uuidv4 } = require('uuid');
// ... express 및 multer 설정 생략 ...

// 파일 업로드 API
app.post('/api/files', upload.single('file'), async (req, res) => {
  const file = req.file;
  const archiveOption = req.body.archiveOption || 'off';
  const isArchive = archiveOption === 'on';
  const userId = req.body.userId;
  const s3Key = `chat/${userId}/${Date.now()}-${uuidv4()}${path.extname(file.originalname)}`;

  const uploadParams = {
    Bucket: process.env.S3_BUCKET,
    Key: s3Key,
    Body: fs.createReadStream(file.path),
    ContentType: file.mimetype,
    Tagging: isArchive ? 'archive=true' : 'archive=false',
  };

  await s3Client.send(new PutObjectCommand(uploadParams));
  // DB 저장 로직 생략...
  res.json({ success: true, s3Key });
});

// 프리사인드 URL 생성 API
app.get('/api/files/url', async (req, res) => {
  const command = new GetObjectCommand({
    Bucket: process.env.S3_BUCKET,
    Key: req.query.s3Key,
  });

  const url = await getSignedUrl(s3Client, command, { expiresIn: 300 }); // 5분 유효
  res.json({ downloadUrl: url });
});
```

---

## 🔄 Lifecycle Rule 설정 (자동 삭제)

1. **버킷 선택**: S3 콘솔 → `my-chat-bucket` 클릭
2. **관리 탭**: "수명 주기 규칙" → "수명 주기 규칙 만들기"
3. **규칙 설정 (JSON 예시)**:

```json
{
  "Rules": [
    {
      "ID": "DeleteTemporaryFiles",
      "Filter": {
        "Tag": {
          "Key": "archive",
          "Value": "false"
        }
      },
      "Status": "Enabled",
      "Expiration": {
        "Days": 1
      }
    }
  ]
}
```

**의미**: `archive=false` 태그가 달린 객체는 생성 후 1일 뒤에 자동으로 삭제됩니다.

---

## 🏷️ Object Tag 기반 관리의 장점

- **파일 이동 불필요**: 폴더를 옮길 필요 없이 태그만 수정하면 정책이 변경됩니다.
- **유연한 업그레이드**: 사용자가 나중에 "이 파일 저장"을 클릭하면 S3 태그를 `archive=true`로 바꾸기만 하면 됩니다.

---

## 💰 가격 예상 (서울 리전 기준)

| 항목      | 단가 (USD)        | 설명                   |
| --------- | ----------------- | ---------------------- |
| 스토리지  | ~$0.025 / GB / 월 | 표준 저장소 비용       |
| PUT 요청  | $0.005 / 1,000건  | 파일 업로드 시 발생    |
| GET 요청  | $0.0004 / 1,000건 | 파일 다운로드 시 발생  |
| 태그 작업 | $0.01 / 10,000건  | 태그 추가/변경 시 발생 |

> 💡 **Free Tier**: 첫 12개월간 5GB 스토리지 및 일정량의 요청이 무료로 제공됩니다.

---

## 🛠️ 트러블슈팅

### 1. AccessDenied 오류

- **원인**: IAM 사용자 권한 부족 또는 S3 버킷 정책 차단
- **해결**: IAM 사용자에게 `AmazonS3FullAccess`가 있는지 확인하고, 버킷의 "퍼블릭 액세스 차단" 설정을 점검하세요.

### 2. 파일이 1일 뒤에 삭제되지 않음

- **원인**: S3 Lifecycle 정책은 UTC 00:00에 일괄 처리되므로 반영에 최대 24시간이 더 걸릴 수 있습니다.
- **해결**: 규칙 상태가 "Enabled"인지 확인하고 하루 더 기다려 보십시오.

---

## ✅ 체크리스트

- [ ] AWS 계정 및 결제 수단 등록
- [ ] S3 버킷 생성 (ap-northeast-2)
- [ ] IAM 사용자 생성 및 액세스 키 발급
- [ ] .env 파일에 자격 증명 입력
- [ ] S3 Lifecycle Rule (태그 기반) 설정 완료
- [ ] 파일 업로드 및 프리사인드 URL 테스트 완료

---

**작성자**: AI Assistant  
**마지막 수정**: 2026년 1월 16일  
**상태**: 🚀 완성
